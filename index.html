<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Resort Weather Map</title>
    
    <!-- Leaflet CSS - Required for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Reset default margins and padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* Map container takes up full viewport */
        #map {
            width: 100%;
            height: 100vh;
        }

        /* Custom styling for the popup content */
        .resort-popup {
            font-family: Arial, sans-serif;
            min-width: 200px;
        }

        .resort-popup h3 {
            margin: 0 0 10px 0;
            color: #2c5aa0;
            font-size: 18px;
        }

        .resort-popup p {
            margin: 5px 0;
            font-size: 14px;
        }

        .resort-popup .label {
            font-weight: bold;
            color: #555;
        }

        .resort-popup .day-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .resort-popup .day-section:first-of-type {
            margin-top: 10px;
            border-top: none;
        }

        .resort-popup .day-title {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }

        /* Loading indicator shown while weather data is being fetched */
        .loading {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
        }

        /* Toggle button for current vs weekend view */
        .view-toggle {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            gap: 0;
        }

        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #2c5aa0;
            background: white;
            color: #2c5aa0;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .view-toggle button:first-child {
            border-radius: 5px 0 0 5px;
        }

        .view-toggle button:last-child {
            border-radius: 0 5px 5px 0;
            border-left: none;
        }

        .view-toggle button.active {
            background: #2c5aa0;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #e3f2fd;
        }

        /* Color legend for ski conditions */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        .legend-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Map container where Leaflet will render the interactive map -->
    <div id="map"></div>
    
    <!-- View toggle button -->
    <div class="view-toggle">
        <button id="currentBtn" class="active" onclick="switchView('current')">Current Conditions</button>
        <button id="weekendBtn" onclick="switchView('weekend')">Weekend Forecast</button>
    </div>

    <!-- Loading indicator (hidden by default via JavaScript) -->
    <div id="loading" class="loading">Loading weather data...</div>

    <!-- Legend explaining marker colors -->
    <div class="legend">
        <h4>Ski Conditions</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4CAF50;"></div>
            <span>Excellent (Fresh snow, cold)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #FFC107;"></div>
            <span>Moderate (Some snow, cold)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #F44336;"></div>
            <span>Poor (No snow or warm/windy)</span>
        </div>
        <div class="legend-note" id="legendNote">
            Click markers for details
        </div>
    </div>

    <!-- Leaflet JavaScript library - Required for map functionality -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" ></script>
    
    <script>
        // =================================================================
        // SKI RESORT DATA ARRAY
        // =================================================================
        const skiResorts = [
            {
                name: "Massanutten Resort",
                lat: 38.4047, 
                lng: -78.7547,
                elevation: 533,//in meters
                distanceFromDC: "130 miles (2.5 hours)",
                notes: "Has an indoor water park.",
                webcamSite: "https://www.massresort.com/play/snow-sports/snow-webcams/"

            },
            {
                name: "Whitetail Resort",
                lat: 39.7426,
                lng: -77.9336,
                elevation: 263.7,//in meters
                distanceFromDC: "93 miles (1.7 hours)",
                notes:"",
                webcamSite:"https://www.skiwhitetail.com/the-mountain/mountain-conditions/mountain-cams.aspx"
            },
            {
                name: "Seven Springs",
                lat: 40.0231,
                lng: -79.2977,
                elevation: 683,//in meters
                distanceFromDC: "200 miles (3 hours)",
                notes:"",
                webcamSite:"https://www.7springs.com/the-mountain/mountain-conditions/mountain-cams.aspx"
            },
            {
                name: "Snowshoe Mountain",
                lat: 38.4032,
                lng: -79.9938,
                elevation: 1020,//in meters
                distanceFromDC: "230 miles (4.3 hours)",
                notes:"",
                webcamSite:"https://www.snowshoemtn.com/media-room/web-cams"
            },
            {
                name: "Liberty Mountain",
                lat: 39.7638,
                lng: -77.3755,
                elevation: 170,//in meters
                distanceFromDC: "82 miles (1.5 hours)",
                notes:"",
                webcamSite:"https://www.libertymountainresort.com/the-mountain/mountain-conditions/mountain-cams.aspx"
            },
             {
                name: "Wisp Resort",
                lat: 39.5570,
                lng: -79.3635,
                elevation: 736,//in meters
                distanceFromDC: "183 miles (3.1 hours)",
                notes:"",
                webcamSite:"https://www.wispresort.com/mountain-report-cams/"
            }
        ];

        // =================================================================
        // GLOBAL VARIABLES
        // =================================================================
        let map;
        let markers = [];
        let currentWeatherData = {};
        let weekendWeatherData = {};
        let unifiedWeatherData = {}; // NEW: Unified timeline data structure
        let evaluationCache = {}; // NEW: Pre-calculated evaluations for performance
        let currentView = 'current';
        let openPopupResortName = null; // Track which popup is open

        // =================================================================
        // MAP INITIALIZATION
        // =================================================================
        map = L.map('map');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // =================================================================
        // WEATHER CONDITION EVALUATION (NEW SYSTEM)
        // =================================================================

        /**
         * Evaluates ski conditions for a specific date using lookback logic
         * @param {Object} weatherTimeline - The resort's full weather timeline
         * @param {string} targetDate - Date to evaluate (YYYY-MM-DD)
         * @returns {Object} { color: 'green'|'yellow'|'red', summary: 'explanation text' }
         */
        function evaluateSkiConditions(weatherTimeline, targetDate) {
            const { timeline, dateIndex } = weatherTimeline;
            const targetIdx = dateIndex[targetDate];

            if (targetIdx === undefined) {
                return { color: 'red', summary: 'No weather data available' };
            }

            const targetDay = timeline[targetIdx];

            // STEP 1: Check wind speeds (independent red trigger)
            const windCheck = checkWindSpeeds(targetDay);
            if (windCheck.isRed) {
                return { color: 'red', summary: windCheck.summary };
            }

            // STEP 2: Analyze snowfall and temperature history
            const lookback2Days = analyzeLookback(timeline, targetIdx, 2);
            const lookback5Days = analyzeLookback(timeline, targetIdx, 5);
            const lookback7Days = analyzeLookback(timeline, targetIdx, 7);

            // STEP 3: Apply Green/Yellow/Red criteria

            // GREEN: Snowed in last 2 days AND no thaw in last 2 days
            if (lookback2Days.hadSnow && !lookback2Days.hadThaw) {
                return {
                    color: 'green',
                    summary: `${lookback2Days.totalSnow.toFixed(1)}" fresh snow in last 2 days, temps ${lookback2Days.minTemp.toFixed(0)}-${lookback2Days.maxTemp.toFixed(0)}°F`
                };
            }

            // YELLOW: Snowed in last 5 days AND no thaw in last 5 days
            if (lookback5Days.hadSnow && !lookback5Days.hadThaw) {
                return {
                    color: 'yellow',
                    summary: `${lookback5Days.totalSnow.toFixed(1)}" snow in last 5 days, stayed below freezing`
                };
            }

            // RED: No snow in last 7 days
            if (!lookback7Days.hadSnow) {
                return {
                    color: 'red',
                    summary: 'No snowfall in last 7 days'
                };
            }

            // RED: Less than 0.5" snow since last thaw
            const snowSinceThaw = calculateSnowSinceLastThaw(timeline, targetIdx);
            if (snowSinceThaw.total < 0.5) {
                const dayOfWeek = getDayOfWeek(snowSinceThaw.thawDate);
                return {
                    color: 'red',
                    summary: `Only ${snowSinceThaw.total.toFixed(1)}" since temps hit ${snowSinceThaw.maxTemp.toFixed(0)}°F on ${dayOfWeek}`
                };
            }

            // DEFAULT: Yellow (some snow but not enough for green)
            return {
                color: 'yellow',
                summary: `${lookback7Days.totalSnow.toFixed(1)}" snow in last week`
            };
        }

        /**
         * Checks wind speeds for the target day (forecast only)
         * @returns {Object} { isRed: boolean, summary: string }
         */
        function checkWindSpeeds(targetDay) {
            // Historical days or missing wind data, assume OK
            if (!targetDay.hourlyWinds || targetDay.hourlyWinds.length < 17) {
                return { isRed: false, summary: '' };
            }

            // Check ski hours: 7am-4pm (indices 7-16)
            const skiHourWinds = targetDay.hourlyWinds.slice(7, 17);
            const highWindHours = [];
            let maxWind = 0;
            let minWind = 999;

            skiHourWinds.forEach((wind, idx) => {
                if (wind >= 20) {
                    const hour = 7 + idx;
                    highWindHours.push(hour);
                    maxWind = Math.max(maxWind, wind);
                    minWind = Math.min(minWind, wind);
                }
            });

            if (highWindHours.length === 0) {
                return { isRed: false, summary: '' };
            }

            // Format hour ranges
            const ranges = formatHourRanges(highWindHours);
            const windRange = minWind === maxWind ?
                `${Math.round(maxWind)} MPH` :
                `${Math.round(minWind)}-${Math.round(maxWind)} MPH`;

            return {
                isRed: true,
                summary: `Winds ${windRange} from ${ranges}`
            };
        }

        /**
         * Analyzes lookback period for snow and thaw
         * @param {Array} timeline - Full timeline
         * @param {number} targetIdx - Index of target date
         * @param {number} daysBack - How many days to look back
         * @returns {Object} { hadSnow: boolean, hadThaw: boolean, totalSnow: number, minTemp: number, maxTemp: number }
         */
        function analyzeLookback(timeline, targetIdx, daysBack) {
            let totalSnow = 0;
            let hadThaw = false;
            let minTemp = 999;
            let maxTemp = -999;

            // Look back 'daysBack' days, not including target day itself
            const startIdx = Math.max(0, targetIdx - daysBack);

            for (let i = startIdx; i < targetIdx; i++) {
                const day = timeline[i];
                totalSnow += day.dailySnowfall;
                if (day.hadFreezingTemps) {
                    hadThaw = true;
                }
                minTemp = Math.min(minTemp, day.minTemp);
                maxTemp = Math.max(maxTemp, day.maxTemp);
            }

            return {
                hadSnow: totalSnow > 0,
                hadThaw: hadThaw,
                totalSnow: totalSnow,
                minTemp: minTemp === 999 ? 0 : minTemp,
                maxTemp: maxTemp === -999 ? 0 : maxTemp
            };
        }

        /**
         * Calculates total snow since the last time temps went above freezing
         * @returns {Object} { total: number, thawDate: string, maxTemp: number }
         */
        function calculateSnowSinceLastThaw(timeline, targetIdx) {
            let totalSnow = 0;
            let thawDate = null;
            let maxTemp = 32;

            // Walk backwards from target date
            for (let i = targetIdx - 1; i >= 0; i--) {
                const day = timeline[i];

                // If we hit a thaw day, stop
                if (day.hadFreezingTemps) {
                    thawDate = day.date;
                    maxTemp = day.maxTemp;
                    break;
                }

                totalSnow += day.dailySnowfall;
            }

            return {
                total: totalSnow,
                thawDate: thawDate || 'unknown',
                maxTemp: maxTemp
            };
        }

        /**
         * Formats hour ranges for wind warnings
         * Example: [10, 11, 12, 14, 15] → "10am-1pm, 2pm-4pm"
         */
        function formatHourRanges(hours) {
            if (hours.length === 0) return '';

            const ranges = [];
            let rangeStart = hours[0];
            let rangePrev = hours[0];

            for (let i = 1; i < hours.length; i++) {
                if (hours[i] !== rangePrev + 1) {
                    // End of range
                    ranges.push(formatRange(rangeStart, rangePrev));
                    rangeStart = hours[i];
                }
                rangePrev = hours[i];
            }

            // Add final range
            ranges.push(formatRange(rangeStart, rangePrev));

            return ranges.join(', ');
        }

        function formatRange(start, end) {
            const formatHour = (h) => {
                const ampm = h >= 12 ? 'pm' : 'am';
                const hour12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                return `${hour12}${ampm}`;
            };

            if (start === end) {
                return formatHour(start);
            }
            return `${formatHour(start)}-${formatHour(end + 1)}`;
        }

        /**
         * Converts date string to day of week
         * @param {string} dateString - Date in YYYY-MM-DD format
         * @returns {string} Day of week (e.g., "Thursday")
         */
        function getDayOfWeek(dateString) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(dateString + 'T12:00:00'); // Add time to avoid timezone issues
            return days[date.getDay()];
        }

        /**
         * Pre-calculates evaluations for today, Saturday, and Sunday
         * @param {string} resortName - Name of the resort
         * @param {Object} weatherTimeline - The resort's weather timeline
         */
        function cacheEvaluations(resortName, weatherTimeline) {
            const today = formatDateLocal(new Date());
            const saturday = getNextSaturday();
            const sunday = getNextSunday();

            evaluationCache[resortName] = {
                today: evaluateSkiConditions(weatherTimeline, today),
                saturday: evaluateSkiConditions(weatherTimeline, saturday),
                sunday: evaluateSkiConditions(weatherTimeline, sunday)
            };
        }

        // =================================================================
        // MARKER COLOR MAPPING
        // =================================================================
        function getMarkerColor(color) {
            const colors = {
                'good': '#4CAF50',      // Legacy support
                'moderate': '#FFC107',  // Legacy support
                'poor': '#F44336',      // Legacy support
                'green': '#4CAF50',     // NEW system
                'yellow': '#FFC107',    // NEW system
                'red': '#F44336'        // NEW system
            };
            return colors[color] || '#999999';
        }

        // =================================================================
        // DATE CALCULATION HELPERS
        // =================================================================
       function formatDateLocal(date) {
    const year = date.getFullYear();
    // getMonth() returns 0-11, so we add 1. padStart ensures '05' instead of '5'
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getNextSaturday() {
    const now = new Date();
    const dayOfWeek = now.getDay();
    
    // Logic: If Sat/Sun, jump to next week's Sat. Else, upcoming Sat this week.
    let daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
    if (daysUntilSaturday === 0 || dayOfWeek === 0) {
        daysUntilSaturday = dayOfWeek === 0 ? 6 : 7;
    }

    // Use setDate for DST safety instead of adding milliseconds
    const saturday = new Date(now); 
    saturday.setDate(now.getDate() + daysUntilSaturday);
    
    return formatDateLocal(saturday);
}

function getNextSunday() {
    const now = new Date();
    const dayOfWeek = now.getDay();

    // Logic: If Sat/Sun, jump to next week's Sun. Else, upcoming Sun this week.
    let daysUntilSunday = (7 - dayOfWeek) % 7;
    if (daysUntilSunday === 0 || dayOfWeek === 6) {
        daysUntilSunday = dayOfWeek === 0 ? 7 : 8;
    }

    // Use setDate for DST safety
    const sunday = new Date(now);
    sunday.setDate(now.getDate() + daysUntilSunday);
    
    return formatDateLocal(sunday);
}
        // =================================================================
        // WEATHER DATA FETCHING - CURRENT
        // =================================================================
        async function fetchCurrentWeather(lat, lng, elevation) {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            const startDate = yesterday.toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];
            
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,weathercode,windspeed_10m,snowfall&hourly=snowfall&start_date=${startDate}&end_date=${endDate}&elevation=${elevation}&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                let last24hSnow = 0;
                if (data.hourly && data.hourly.snowfall) {
                    const recentSnowfall = data.hourly.snowfall.slice(-24);
                    last24hSnow = recentSnowfall.reduce((sum, value) => sum + (value || 0), 0);
                }
                
                return {
                    temperature: data.current.temperature_2m,
                    weatherCode: data.current.weathercode,
                    windSpeed: data.current.windspeed_10m,
                    snowfall: data.current.snowfall || 0,
                    snowfall24h: last24hSnow.toFixed(1),
                };
            } catch (error) {
                console.error('Error fetching current weather:', error);
                return null;
            }
        }

        // =================================================================
        // WEATHER DATA FETCHING - WEEKEND FORECAST
        // =================================================================
        async function fetchWeekendForecast(lat, lng, elevation) {
            const saturday = getNextSaturday();
            const sunday = getNextSunday();
            
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_max,temperature_2m_min,weathercode,windspeed_10m_max,snowfall_sum&start_date=${saturday}&end_date=${sunday}&elevation=${elevation}&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch`;
            console.log (url);
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.daily) return null;
                
                return {
                    saturday: {
                        temperature: (data.daily.temperature_2m_max[0] + data.daily.temperature_2m_min[0]) / 2,
                        tempMax: data.daily.temperature_2m_max[0],
                        tempMin: data.daily.temperature_2m_min[0],
                        weatherCode: data.daily.weathercode[0],
                        windSpeed: data.daily.windspeed_10m_max[0],
                        snowfall: data.daily.snowfall_sum[0] || 0,
                    },
                    sunday: {
                        temperature: (data.daily.temperature_2m_max[1] + data.daily.temperature_2m_min[1]) / 2,
                        tempMax: data.daily.temperature_2m_max[1],
                        tempMin: data.daily.temperature_2m_min[1],
                        weatherCode: data.daily.weathercode[1],
                        windSpeed: data.daily.windspeed_10m_max[1],
                        snowfall: data.daily.snowfall_sum[1] || 0,
                    }
                };
            } catch (error) {
                console.error('Error fetching weekend forecast:', error);
                return null;
            }
        }

        // =================================================================
        // UNIFIED WEATHER DATA FETCHING (NEW SYSTEM)
        // =================================================================
        async function fetchExtendedForecast(lat, lng, elevation) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,windspeed_10m&daily=snowfall_sum&past_days=7&forecast_days=16&elevation=${elevation}&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.hourly || !data.daily) return null;

                return data;
            } catch (error) {
                console.error('Error fetching extended forecast:', error);
                return null;
            }
        }

        function processWeatherData(apiData, resortName) {
            if (!apiData || !apiData.hourly || !apiData.daily) {
                return { timeline: [], dateIndex: {} };
            }

            const timeline = [];
            const dateIndex = {};

            // Get all dates from the daily data
            const dates = apiData.daily.time;
            const dailySnowfall = apiData.daily.snowfall_sum;

            // Get hourly data
            const hourlyTimes = apiData.hourly.time;
            const hourlyTemps = apiData.hourly.temperature_2m;
            const hourlyWinds = apiData.hourly.windspeed_10m;

            // Today's date for determining historical vs forecast
            const today = formatDateLocal(new Date());

            // Process each day
            dates.forEach((date, dayIdx) => {
                // Extract hourly data for this specific day (24 hours)
                const startHour = dayIdx * 24;
                const endHour = startHour + 24;

                const dayHourlyTemps = hourlyTemps.slice(startHour, endHour);
                const dayHourlyWinds = hourlyWinds.slice(startHour, endHour);

                // Check if any hour went above freezing (≥32°F)
                const hadFreezingTemps = dayHourlyTemps.some(temp => temp >= 32);

                // Determine if historical or forecast
                const type = date < today ? "historical" : "forecast";

                timeline.push({
                    date: date,
                    type: type,
                    dailySnowfall: dailySnowfall[dayIdx] || 0,
                    hourlyTemps: dayHourlyTemps,
                    hourlyWinds: dayHourlyWinds,
                    maxTemp: Math.max(...dayHourlyTemps),
                    minTemp: Math.min(...dayHourlyTemps),
                    hadFreezingTemps: hadFreezingTemps
                });

                dateIndex[date] = timeline.length - 1;
            });

            return { timeline, dateIndex };
        }

        // =================================================================
        // WEATHER CODE INTERPRETATION
        // =================================================================
        function getWeatherDescription(code) {
            const weatherCodes = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail',
                99: 'Thunderstorm with heavy hail'
            };
            return weatherCodes[code] || 'Unknown';
        }

        // =================================================================
        // POPUP CONTENT CREATION
        // =================================================================
        function createCurrentPopupContent(resort, evaluation) {
            if (!evaluation) {
                return `
                    <div class="resort-popup">
                        <h3>${resort.name}</h3>
                        <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                        <p>Weather data unavailable</p>
                    </div>
                `;
            }

            // NEW SYSTEM: evaluation is {color, summary}
            if (evaluation.color && evaluation.summary) {
                const conditionText = {
                    'green': 'Excellent',
                    'yellow': 'Moderate',
                    'red': 'Poor'
                }[evaluation.color];

                return `
                    <div class="resort-popup">
                        <h3>${resort.name}</h3>
                        <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                        <p><span class="label">Conditions:</span> ${conditionText}</p>
                        <p><span class="label">Why:</span> ${evaluation.summary}</p>
                        <p><span class="label">Notes:</span> ${resort.notes}</p>
                        <a href="${resort.webcamSite}" target="_blank" rel="noopener noreferrer">Mountain Cams</a>
                    </div>
                `;
            }

            // LEGACY SYSTEM: evaluation is old weather object
            return `
                <div class="resort-popup">
                    <h3>${resort.name}</h3>
                    <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                    <p><span class="label">Temperature:</span> ${evaluation.temperature}°F</p>
                    <p><span class="label">Conditions:</span> ${getWeatherDescription(evaluation.weatherCode)}</p>
                    <p><span class="label">Wind Speed:</span> ${evaluation.windSpeed} mph</p>
                    <p><span class="label">Snowfall (24h):</span> ${evaluation.snowfall24h} inches</p>
                    <p><span class="label">Notes:</span> ${resort.notes}</p>
                    <a href="${resort.webcamSite}" target="_blank" rel="noopener noreferrer">Mountain Cams</a>
                </div>
            `;
        }

        function createWeekendPopupContent(resort, saturdayEval, sundayEval) {
            // Handle both new system (two separate evaluations) and legacy system (single weather object)

            // NEW SYSTEM: saturdayEval and sundayEval are evaluation objects
            if (saturdayEval && saturdayEval.color && sundayEval && sundayEval.color) {
                const satConditionText = {
                    'green': 'Excellent',
                    'yellow': 'Moderate',
                    'red': 'Poor'
                }[saturdayEval.color];

                const sunConditionText = {
                    'green': 'Excellent',
                    'yellow': 'Moderate',
                    'red': 'Poor'
                }[sundayEval.color];

                return `
                    <div class="resort-popup">
                        <h3>${resort.name}</h3>
                        <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                        <p><span class="label">Notes:</span> ${resort.notes}</p>
                        <a href="${resort.webcamSite}" target="_blank" rel="noopener noreferrer">Mountain Cams</a>

                        <div class="day-section">
                            <div class="day-title">Saturday</div>
                            <p><span class="label">Conditions:</span> ${satConditionText}</p>
                            <p><span class="label">Why:</span> ${saturdayEval.summary}</p>
                        </div>

                        <div class="day-section">
                            <div class="day-title">Sunday</div>
                            <p><span class="label">Conditions:</span> ${sunConditionText}</p>
                            <p><span class="label">Why:</span> ${sundayEval.summary}</p>
                        </div>
                    </div>
                `;
            }

            // LEGACY SYSTEM: saturdayEval is actually the old weather object
            const weather = saturdayEval;
            if (!weather) {
                return `
                    <div class="resort-popup">
                        <h3>${resort.name}</h3>
                        <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                        <p>Weekend forecast unavailable</p>
                    </div>
                `;
            }

            return `
                <div class="resort-popup">
                    <h3>${resort.name}</h3>
                    <p><span class="label">Distance from DC:</span> ${resort.distanceFromDC}</p>
                    <p><span class="label">Notes:</span> ${resort.notes}</p>
                    <a href="${resort.webcamSite}" target="_blank" rel="noopener noreferrer">Mountain Cams</a>

                    <div class="day-section">
                        <div class="day-title">Saturday</div>
                        <p><span class="label">Temperature:</span> ${weather.saturday.tempMin}°F - ${weather.saturday.tempMax}°F</p>
                        <p><span class="label">Conditions:</span> ${getWeatherDescription(weather.saturday.weatherCode)}</p>
                        <p><span class="label">Wind Speed:</span> ${weather.saturday.windSpeed} mph</p>
                        <p><span class="label">Expected Snowfall:</span> ${weather.saturday.snowfall.toFixed(1)} inches</p>
                    </div>

                    <div class="day-section">
                        <div class="day-title">Sunday</div>
                        <p><span class="label">Temperature:</span> ${weather.sunday.tempMin}°F - ${weather.sunday.tempMax}°F</p>
                        <p><span class="label">Conditions:</span> ${getWeatherDescription(weather.sunday.weatherCode)}</p>
                        <p><span class="label">Wind Speed:</span> ${weather.sunday.windSpeed} mph</p>
                        <p><span class="label">Expected Snowfall:</span> ${weather.sunday.snowfall.toFixed(1)} inches</p>
                    </div>
                </div>
            `;
        }

        // =================================================================
        // SPLIT MARKER CREATION (SVG-based for weekend view)
        // =================================================================
        function createSplitMarker(resort, saturdayEval, sundayEval) {
            // Handle both NEW system (evaluation objects) and LEGACY system (weather object)

            let satColor, sunColor;

            // NEW SYSTEM: saturdayEval and sundayEval are evaluation objects with .color
            if (saturdayEval && saturdayEval.color && sundayEval && sundayEval.color) {
                satColor = getMarkerColor(saturdayEval.color);
                sunColor = getMarkerColor(sundayEval.color);
            }
            // LEGACY SYSTEM: saturdayEval is actually the old weather object
            else {
                const weather = saturdayEval;
                if (!weather) {
                    return createRegularMarker(resort, null);
                }

                // Use old evaluation system
                const satCondition = evaluateSkiConditions({
                    temperature: weather.saturday.tempMax,
                    windSpeed: weather.saturday.windSpeed
                });
                const sunCondition = evaluateSkiConditions({
                    temperature: weather.sunday.tempMax,
                    windSpeed: weather.sunday.windSpeed
                });
                satColor = getMarkerColor(satCondition);
                sunColor = getMarkerColor(sunCondition);
            }

            // Create custom SVG icon with split colors
            const svgIcon = L.divIcon({
                html: `
                    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="${satColor}" stroke="#333" stroke-width="2"/>
                        <path d="M 12 2 A 10 10 0 0 1 12 22 Z" fill="${sunColor}"/>
                        <circle cx="12" cy="12" r="10" fill="none" stroke="#333" stroke-width="2"/>
                    </svg>
                `,
                className: 'split-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });

            const marker = L.marker([resort.lat, resort.lng], {
                icon: svgIcon
            }).addTo(map);

            marker.bindPopup(createWeekendPopupContent(resort, saturdayEval, sundayEval));

            // Store resort name on the marker for easy lookup
            marker.resortName = resort.name;

            return marker;
        }

        // =================================================================
        // REGULAR MARKER CREATION (for current view)
        // =================================================================
        function createRegularMarker(resort, evaluation) {
            // Handle both NEW system (evaluation object) and LEGACY system (weather object)

            let color;

            // NEW SYSTEM: evaluation is {color, summary}
            if (evaluation && evaluation.color) {
                color = getMarkerColor(evaluation.color);
            }
            // LEGACY SYSTEM: evaluation is old weather object
            else if (evaluation && evaluation.temperature !== undefined) {
                const condition = evaluateSkiConditions(evaluation);
                color = getMarkerColor(condition);
            }
            // No data
            else {
                color = getMarkerColor('moderate');
            }

            const marker = L.circleMarker([resort.lat, resort.lng], {
                radius: 10,
                fillColor: color,
                color: '#333',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindPopup(createCurrentPopupContent(resort, evaluation));

            // Store resort name on the marker for easy lookup
            marker.resortName = resort.name;

            return marker;
        }

        // =================================================================
        // VIEW SWITCHING
        // =================================================================
        function switchView(view) {
            // Check which popup is open before doing anything
            let resortToReopen = null;
            markers.forEach(marker => {
                if (marker.isPopupOpen()) {
                    resortToReopen = marker.resortName;
                }
            });

            currentView = view;

            // Update button states
            document.getElementById('currentBtn').classList.toggle('active', view === 'current');
            document.getElementById('weekendBtn').classList.toggle('active', view === 'weekend');

            // Update legend note
            const legendNote = document.getElementById('legendNote');
            if (view === 'weekend') {
                legendNote.innerHTML = 'Left: Saturday | Right: Sunday';
            } else {
                legendNote.innerHTML = 'Click markers for details';
            }

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Create new markers based on view
            skiResorts.forEach(resort => {
                let marker;
                if (view === 'current') {
                    // NEW SYSTEM: Use cached evaluation if available, otherwise fallback to legacy
                    const evaluation = evaluationCache[resort.name]?.today || currentWeatherData[resort.name];
                    marker = createRegularMarker(resort, evaluation);
                } else {
                    // NEW SYSTEM: Use cached evaluations if available, otherwise fallback to legacy
                    if (evaluationCache[resort.name]) {
                        const saturdayEval = evaluationCache[resort.name].saturday;
                        const sundayEval = evaluationCache[resort.name].sunday;
                        marker = createSplitMarker(resort, saturdayEval, sundayEval);
                    } else {
                        marker = createSplitMarker(resort, weekendWeatherData[resort.name]);
                    }
                }
                markers.push(marker);

                // Re-open the popup if it was open for this resort
                if (resortToReopen === resort.name) {
                    // Use requestAnimationFrame to ensure DOM is updated
                    requestAnimationFrame(() => {
                        marker.openPopup();
                    });
                }
            });
        }

        // =================================================================
        // MAIN INITIALIZATION FUNCTION
        // =================================================================
        async function initializeMap() {
            document.getElementById('loading').style.display = 'block';

            // NEW SYSTEM: Fetch extended forecast data for all resorts
            for (const resort of skiResorts) {
                try {
                    const forecastData = await fetchExtendedForecast(
                        resort.lat, resort.lng, resort.elevation
                    );

                    if (forecastData) {
                        unifiedWeatherData[resort.name] = processWeatherData(
                            forecastData, resort.name
                        );

                        cacheEvaluations(resort.name, unifiedWeatherData[resort.name]);
                    }

                    // LEGACY: Keep old data fetching for backwards compatibility during transition
                    currentWeatherData[resort.name] = await fetchCurrentWeather(resort.lat, resort.lng, resort.elevation);
                    weekendWeatherData[resort.name] = await fetchWeekendForecast(resort.lat, resort.lng, resort.elevation);

                } catch (error) {
                    console.error(`Error fetching data for ${resort.name}:`, error);
                }
            }

            // Create initial markers (current view) using NEW system
            skiResorts.forEach(resort => {
                const evaluation = evaluationCache[resort.name]?.today;
                if (evaluation) {
                    const marker = createRegularMarker(resort, evaluation);
                    markers.push(marker);
                } else {
                    // Fallback to old system if new system failed
                    const marker = createRegularMarker(resort, currentWeatherData[resort.name]);
                    markers.push(marker);
                }
            });

            document.getElementById('loading').style.display = 'none';

            // Auto-zoom map to fit all markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {
                    padding: [50, 50]
                });
            }
        }

        // =================================================================
        // START THE APPLICATION
        // =================================================================
        initializeMap();
    </script>
</body>
</html>